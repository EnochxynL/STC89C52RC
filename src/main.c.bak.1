#include <reg51.h>

#include "it.h"
#include "tim.h"
#include "ex.h"
#include "uart.h"
void example_3_8()
{
	
}

__sfr AUXR = 0x8E;
void STC89_compatibility_for_STC15()
{
	AUXR = 0x00;
}

// CLASS UART
__bit busy;
volatile unsigned char wptr;
volatile unsigned char rptr;
volatile unsigned char buffer[16];
void uart_start_it()
{
	UART0_BAUD();
	UART0_CONFIG(UART0_MODE_8V);
	RX_ENABLED_UART0 = 1;
	RX_FILTERED_UART0 = 0;
	TI = 0;
	RI = 0;
	IT_ENABLED_UART = 1;
	
	TIM1_CONFIG(TIM1_MODE_8);
	TIM1_AUTOLOAD_MODE_8(BAUD_TO_LOAD(11059200L, 9600));
	TIM1_START();
	IT_ENABLED_TIM1 = 0;
}
void uart_callback() __interrupt(it_uart)
{
	if (TI)
	{
		TI = 0;
		busy = 0;
	}
	if (RI)
	{
		RI = 0;
		buffer[wptr++] = SBUF;
		wptr &= 0x0f;
	}
}
void uart_sendChar(char dat)
{
	while (busy);
	busy = 1;
	SBUF = dat;
}
void uart_sendStr(char *p)
{
	while (*p)
	{
		uart_sendChar(*p++);
	}
}

void answer_3_8()
{
	STC89_compatibility_for_STC15();
	
	IT_ENABLED_ALL = 0;
	
	busy = 0;
	wptr = 0;
	rptr = 0;
	uart_start_it();
	
	IT_ENABLED_ALL = 1;

	uart_sendStr("Uart Test !\r\n");
	while(1)
	{
		if (rptr != wptr)
		{
			uart_sendChar(buffer[rptr++]);
			rptr &= 0x0f;
		}
	}
}